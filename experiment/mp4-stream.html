<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stream Example</title>
</head>
<body>
<video id="videoElement" autoplay playsinline controls></video>
<button id="switchButton">Switch to BigBuckBunny</button>

<script>
    const video = document.getElementById('videoElement');
    const switchButton = document.getElementById('switchButton');
    let stream;

    // Start the getUserMedia stream
    async function startUserMedia() {
        try {
            // stream = await navigator.mediaDevices.getUserMedia({ video: true });
            // videoElement.srcObject = stream;
        } catch (error) {
            console.error('Error accessing media devices.', error);
        }
    }

    // Replace the getUserMedia stream with BigBuckBunny.mp4
    function switchToVideoFile() {
        if (stream) {
            // Stop the existing stream
            stream.getTracks().forEach(track => track.stop());
        }

        // Create a new MediaSource object
        const mediaSource = new MediaSource();
        window.mediaSource = mediaSource;
        // let mimeCodec = 'video/mp4; codecs="avc1.64001f"'; // H.264 High Profile Level 3.1
        const mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
        video.src = URL.createObjectURL(mediaSource);
        // video.srcObject = mediaSource.handle;

        if (!MediaSource.isTypeSupported(mimeCodec)) {
            console.log("Mime type not supported");
            // mimeCodec = 'video/mp4; codecs="avc1.42E01E"'; // H.264 Baseline Profile Level 3.0
        }

        mediaSource.addEventListener('sourceopen', async ()=>{
            const sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
            const assetURL = 'frag_bunny.mp4';
            const response = await fetch(assetURL);
            const buf = await response.arrayBuffer();
            sourceBuffer.appendBuffer(buf);

            sourceBuffer.addEventListener('updateend', function () {
                    mediaSource.endOfStream();
                    video.play();
                    //console.log(mediaSource.readyState); // ended
                });
            });

    }
    switchButton.addEventListener('click', switchToVideoFile);

    // Initialize the getUserMedia stream
    startUserMedia();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video File Stream testing</title>
    <style>
        body {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>
<button id="camera">Get camera</button>
<button id="show" hidden>Show video</button>
<label for="insert" disabled>Insert video</label>
<input type="checkbox" id="insert">
<br>
<video id="user_video" autoplay playsinline controls muted></video>
<script type="module">
    const cameraButton = document.getElementById('camera');
    const video = document.getElementById('user_video');
    const insertCheckbox = document.getElementById('insert');

    const createMediaStreamTrackFromVideoFile = (videoFile) => {
        return new Promise((resolve, reject) => {
            // Create a video element
            const videoElement = document.createElement('video');
            videoElement.autoplay = true;
            videoElement.muted = true;
            videoElement.loop = true; // Optional: Loop if you want continuous stream

            // Set the source of the video
            videoElement.src = videoFile;

            // When the video metadata is loaded, start playing
            videoElement.onloadedmetadata = () => {
                videoElement.play().then(() => {
                    // Capture the stream from the video element
                    const stream = videoElement.captureStream();
                    const [videoTrack] = stream.getVideoTracks();
                    resolve(videoTrack);
                }).catch(reject);
            };

            // Handle video element errors
            videoElement.onerror = () => {
                reject(new Error(`Error loading video file: ${videoFile}`));
            };
        });
    };

    // Usage
    const videoTrack = await createMediaStreamTrackFromVideoFile('frag_bunny_10s.webm');
    console.log("video file videoTrack:", videoTrack)

    const showBtn = document.getElementById('show');
    showBtn.addEventListener('click', async () => {
        video.srcObject = new MediaStream([videoTrack]);
    });

    cameraButton.onclick = async () => {
        cameraButton.disabled = true;
        insertCheckbox.disabled = false;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const [track] = stream.getVideoTracks();

            const generator = new MediaStreamTrackGenerator({kind: "video"});
            video.srcObject = new MediaStream([generator]);
            const cameraProcessor = new MediaStreamTrackProcessor(track);

            const videoProcessor = new MediaStreamTrackProcessor(videoTrack);
            const videoReader = videoProcessor.readable.getReader();

            await cameraProcessor.readable.
            pipeThrough(new TransformStream({
                transform(cameraFrame, controller) {
                    if(insertCheckbox.checked) {
                        videoReader.read().then(({done, value}) => {
                            if(done) {
                                controller.close();
                                console.log("videoReader done");
                            }
                            else {
                                cameraFrame.close();
                                controller.enqueue(value);
                            }
                        });

                    }
                    else {
                        // console.log(frame);
                        controller.enqueue(cameraFrame);
                    }
                }
            }))
                .pipeTo(generator.writable);



        } catch (error) {
            console.error('Error accessing media devices.', error);
        }
    };



</script>

</body>
</html>

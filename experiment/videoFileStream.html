<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video File Stream testing</title>
    <style>
        body {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>
<button id="camera">Get camera</button>
<button id="show" hidden>Show video</button>
<label for="insert" disabled>Insert video</label>
<input type="checkbox" id="insert">
<br>
<video id="user_video" autoplay playsinline controls muted></video>
<script type="module">
    const cameraButton = document.getElementById('camera');
    const video = document.getElementById('user_video');
    const insertCheckbox = document.getElementById('insert');

    let mediaElement;

    const createMediaStreamFromVideoFile = (videoFile) => {
        return new Promise((resolve, reject) => {
            // Create a video element
            const videoElement = document.createElement('video');
            videoElement.autoplay = true;
            videoElement.muted = true;
            videoElement.loop = true; // Optional: Loop if you want continuous stream

            // Set the source of the video
            videoElement.src = videoFile;

            // When the video metadata is loaded, start playing
            videoElement.onloadedmetadata = () => {
                videoElement.play().then(() => {
                    // Capture the stream from the video element
                    const stream = videoElement.captureStream();
                    // const [videoTrack] = stream.getVideoTracks();

                    mediaElement = videoElement;
                    resolve(stream);
                }).catch(reject);
            };

            // Handle video element errors
            videoElement.onerror = () => {
                reject(new Error(`Error loading video file: ${videoFile}`));
            };
        });
    };

    insertCheckbox.onclick = () => {
        mediaElement.muted = !insertCheckbox.checked;
    };

    cameraButton.onclick = async () => {
        cameraButton.disabled = true;
        insertCheckbox.disabled = false;

        try {
            const constraints = {
                video: true,
                audio: {
                    echoCancellation: false,
                }
            };
            const cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            const mediaStream = await createMediaStreamFromVideoFile('BigBuckBunny_360p30.mp4');

            const videoGenerator = new MediaStreamTrackGenerator({kind: "video"});
            const audioGenerator = new MediaStreamTrackGenerator({kind: "audio"});

            video.srcObject = new MediaStream([videoGenerator, audioGenerator]);

            const cameraVideoProcessor = new MediaStreamTrackProcessor(cameraStream.getVideoTracks()[0]);
            const cameraAudioProcessor = new MediaStreamTrackProcessor(cameraStream.getAudioTracks()[0]);

            const mediaVideoProcessor = new MediaStreamTrackProcessor(mediaStream.getVideoTracks()[0]);
            const mediaAudioProcessor = new MediaStreamTrackProcessor(mediaStream.getAudioTracks()[0]);

            const mediaVideoReader = mediaVideoProcessor.readable.getReader();
            const mediaAudioReader = mediaAudioProcessor.readable.getReader();

            await cameraVideoProcessor.readable
                .pipeThrough(new TransformStream({
                    transform(cameraFrame, controller) {
                        if (insertCheckbox.checked) {
                            mediaVideoReader.read().then(({done, value}) => {
                                if (done) {
                                    controller.close();
                                } else {
                                    cameraFrame.close();
                                    controller.enqueue(value);
                                }
                            });
                        } else {
                            controller.enqueue(cameraFrame);
                        }
                    }
                }))
                .pipeTo(videoGenerator.writable);

            await cameraAudioProcessor.readable
                .pipeThrough(new TransformStream({
                    transform(cameraFrame, controller) {
                        if (insertCheckbox.checked) {
                            mediaAudioReader.read().then(({done, value}) => {
                                if (done) {
                                    controller.close();
                                } else {
                                    cameraFrame.close();
                                    controller.enqueue(value);
                                }
                            });
                        } else {
                            controller.enqueue(cameraFrame);
                        }
                    }
                }))
                .pipeTo(audioGenerator.writable);
        } catch (error) {
            console.error('Error accessing media devices.', error);
        }
    };
</script>

</body>
</html>
